-- LocalScript (StarterGui)
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local WS = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")

local LP = Players.LocalPlayer
local PG = LP:WaitForChild("PlayerGui")
local Remote = RS:FindFirstChild("Framework") and RS.Framework:FindFirstChild("Network") and RS.Framework.Network:FindFirstChild("HandcuffRemote")

local Gui = Instance.new("ScreenGui", PG)
Gui.Name = "HandcuffGUI"
Gui.ResetOnSpawn = false

local Frame = Instance.new("Frame", Gui)
Frame.Size = UDim2.new(0, 200, 0, 200)
Frame.Position = UDim2.new(0.4, 0, 0.4, 0)
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.Active, Frame.Draggable = true, true
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1, 0, 0, 25)
Title.Text = "اوتو كلبشه"
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.new(1, 1, 1)
Title.TextScaled = true

local Box = Instance.new("TextBox", Frame)
Box.Size = UDim2.new(1, -10, 0, 30)
Box.Position = UDim2.new(0, 5, 0, 30)
Box.PlaceholderText = "اكتب بداية الاسم"
Box.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Box.TextColor3 = Color3.new(1, 1, 1)
Box.ClearTextOnFocus = false
Instance.new("UICorner", Box).CornerRadius = UDim.new(0, 6)

local AutoBtn = Instance.new("TextButton", Frame)
AutoBtn.Size = UDim2.new(1, -10, 0, 30)
AutoBtn.Position = UDim2.new(0, 5, 0, 65)
AutoBtn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
AutoBtn.TextColor3 = Color3.new(1, 1, 1)
AutoBtn.Text = "سحب تلقائي: إيقاف"
Instance.new("UICorner", AutoBtn).CornerRadius = UDim.new(0, 6)

local KillBtn = Instance.new("TextButton", Frame)
KillBtn.Size = UDim2.new(1, -10, 0, 30)
KillBtn.Position = UDim2.new(0, 5, 0, 105)
KillBtn.BackgroundColor3 = Color3.fromRGB(55, 0, 0)
KillBtn.TextColor3 = Color3.new(1, 1, 1)
KillBtn.Text = "قتل تلقائي: إيقاف"
Instance.new("UICorner", KillBtn).CornerRadius = UDim.new(0, 6)

local AntiBangBtn = Instance.new("TextButton", Frame)
AntiBangBtn.Size = UDim2.new(1, -10, 0, 30)
AntiBangBtn.Position = UDim2.new(0, 5, 0, 145)
AntiBangBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
AntiBangBtn.TextColor3 = Color3.new(1, 1, 1)
AntiBangBtn.Text = "مضاد بانغ: إيقاف"
Instance.new("UICorner", AntiBangBtn).CornerRadius = UDim.new(0, 6)

local SmallBtnGui = Instance.new("ScreenGui", PG)
SmallBtnGui.ResetOnSpawn = false
local SmallBtn = Instance.new("TextButton", SmallBtnGui)
SmallBtn.Size = UDim2.new(0, 50, 0, 50)
SmallBtn.Position = UDim2.new(0.85, 0, 0.05, 0)
SmallBtn.Text = "Z"
SmallBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
SmallBtn.TextColor3 = Color3.new(1, 1, 1)
SmallBtn.TextScaled = true
SmallBtn.Active, SmallBtn.Draggable = true, true
Instance.new("UICorner", SmallBtn).CornerRadius = UDim.new(0, 6)

local Target, Auto, KillLoop, CharConn, HealthConn
local GuiVisible = false
Frame.Visible = GuiVisible
local KillPos = CFrame.new(243.666275,-21015.7148,-15.5977278,0.4223,-0.0439,-0.9053,0,0.9988,-0.0484,0.9064,0.0204,0.4218)

local SavedTargetName = nil
local SavedAuto = false
local SavedKill = false

local AntiBang = false
local TP_Lock = false
local TP_Cooldown = false

local function startsWith(s,p)
    if not s or not p then return false end
    return s:sub(1,#p):lower() == p:lower()
end

local function findPlayer(part)
    if not part then return nil end
    part = part:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if startsWith(p.Name, part) or startsWith(p.DisplayName, part) then
            return p
        end
    end
    return nil
end

local function getTool()
    local bp = LP:FindFirstChild("Backpack")
    if not bp then return nil end
    local t = bp:FindFirstChild("Normal")
    if t and LP.Character then
        t.Parent = LP.Character
        return t
    end
    return LP.Character and LP.Character:FindFirstChild("Normal")
end

local function safeInvoke(c)
    if not Remote then return end
    pcall(function()
        Remote:InvokeServer(getTool(), c)
    end)
end

local function onChar(c)
    if HealthConn then HealthConn:Disconnect() HealthConn = nil end
    local hum = c:WaitForChild("Humanoid")
    if Auto then
        if hum.Health >= hum.MaxHealth then
            safeInvoke(c)
        else
            HealthConn = hum.HealthChanged:Connect(function(h)
                if Auto and h >= hum.MaxHealth then safeInvoke(c) if HealthConn then HealthConn:Disconnect() HealthConn = nil end end
            end)
        end
    end
end

local function clearSavedTarget()
    SavedTargetName = nil
    SavedAuto = false
    SavedKill = false
end

local function setTarget(p)
    if CharConn then CharConn:Disconnect() CharConn = nil end
    if HealthConn then HealthConn:Disconnect() HealthConn = nil end
    Target = p
    if p then
        SavedTargetName = p.Name
        CharConn = p.CharacterAdded:Connect(onChar)
        if p.Character then onChar(p.Character) end
    end
end

local function killTarget(char)
    local root = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
    if root and char then
        WS.FallenPartsDestroyHeight = 0/0
        local oldPos = root.CFrame
        getTool()
        safeInvoke(char)
        root.CFrame = KillPos
        task.wait(0.3)
        safeInvoke(char)
        root.CFrame = oldPos
    end
end

local KillCharConn = nil
local function startKillLoop()
    if KillCharConn then KillCharConn:Disconnect() KillCharConn = nil end
    if not Target then return end
    if Target.Character then killTarget(Target.Character) end
    KillCharConn = Target.CharacterAdded:Connect(function(newChar)
        task.wait(0.5)
        if KillLoop then
            local hum = newChar:WaitForChild("Humanoid")
            if hum.Health >= hum.MaxHealth then
                killTarget(newChar)
            else
                local temp
                temp = hum.HealthChanged:Connect(function(h)
                    if KillLoop and h >= hum.MaxHealth then
                        killTarget(newChar)
                        if temp then temp:Disconnect() temp = nil end
                    end
                end)
            end
        end
    end)
end

local function toggleGui()
    GuiVisible = not GuiVisible
    Frame.Visible = GuiVisible
end

local function doAntiBangTeleport()
    if TP_Lock or TP_Cooldown then return end
    TP_Lock = true
    TP_Cooldown = true

    local root = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
    if not root then
        TP_Lock = false
        TP_Cooldown = false
        return
    end

    local old = root.CFrame
    root.CFrame = old * CFrame.new(0, -700, 0)
    task.wait(0.7)
    if root and root.Parent then
        root.CFrame = old
    end
    task.delay(1.3, function()
        TP_Cooldown = false
    end)
    TP_Lock = false
end

local TouchedConn = nil
local function connectAntiBangTouch()
    if TouchedConn then TouchedConn:Disconnect() TouchedConn = nil end
    local myRoot = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
    if not myRoot then return end
    TouchedConn = myRoot.Touched:Connect(function(hit)
        if not AntiBang then return end
        if TP_Lock or TP_Cooldown then return end
        local char = hit:FindFirstAncestorWhichIsA("Model")
        if not char then return end
        local p = Players:GetPlayerFromCharacter(char)
        if p and p ~= LP then
            doAntiBangTeleport()
        end
    end)
end

local function connectAntiBangProximityLoop()
    task.spawn(function()
        while true do
            task.wait(0.12)
            if AntiBang and not TP_Lock and not TP_Cooldown then
                local myRoot = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
                if myRoot then
                    for _, plr in ipairs(Players:GetPlayers()) do
                        if plr ~= LP and plr.Character then
                            local otherRoot = plr.Character:FindFirstChild("HumanoidRootPart")
                            if otherRoot then
                                if (myRoot.Position - otherRoot.Position).Magnitude <= 2.2 then
                                    doAntiBangTeleport()
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end

Players.PlayerAdded:Connect(function(p)
    if SavedTargetName and p.Name:lower() == SavedTargetName:lower() then
        setTarget(p)
        Box.Text = p.Name
        if SavedAuto then
            Auto = true
            AutoBtn.Text = "سحب تلقائي: تشغيل"
            if p.Character then task.delay(0.2, function() onChar(p.Character) end) end
        end
        if SavedKill then
            KillLoop = true
            KillBtn.Text = "قتل تلقائي: تشغيل"
            startKillLoop()
        end
    end
end)

Players.PlayerRemoving:Connect(function(p)
    if p == Target then
        Target = nil
        if CharConn then CharConn:Disconnect() CharConn = nil end
        if HealthConn then HealthConn:Disconnect() HealthConn = nil end
    end
end)

Box.FocusLost:Connect(function()
    local found = findPlayer(Box.Text)
    if found then
        setTarget(found)
        SavedTargetName = found.Name
    else
        SavedTargetName = (Box.Text ~= "" and Box.Text) or nil
        Target = nil
    end
end)

AutoBtn.MouseButton1Click:Connect(function()
    Auto = not Auto
    SavedAuto = Auto
    AutoBtn.Text = "سحب تلقائي: " .. (Auto and "تشغيل" or "إيقاف")
    if Auto and Target and Target.Character then
        task.delay(0.1, function() onChar(Target.Character) end)
    end
end)

KillBtn.MouseButton1Click:Connect(function()
    KillLoop = not KillLoop
    SavedKill = KillLoop
    KillBtn.Text = "قتل تلقائي: " .. (KillLoop and "تشغيل" or "إيقاف")
    if KillLoop then
        startKillLoop()
    else
        if KillCharConn then KillCharConn:Disconnect() KillCharConn = nil end
    end
end)

AntiBangBtn.MouseButton1Click:Connect(function()
    AntiBang = not AntiBang
    AntiBangBtn.Text = "مضاد بانغ: " .. (AntiBang and "تشغيل" or "إيقاف")
end)

SmallBtn.MouseButton1Click:Connect(toggleGui)
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.Z then
        toggleGui()
    end
end)

local function createTargetTool()
    local old = LP.Backpack:FindFirstChild("Target Selector")
    if old then old:Destroy() end
    local tool = Instance.new("Tool")
    tool.Name = "Target Selector"
    tool.RequiresHandle = false
    tool.CanBeDropped = false
    tool.Parent = LP:WaitForChild("Backpack")
    local mouse = LP:GetMouse()
    local clickConn
    tool.Equipped:Connect(function()
        if Auto or KillLoop then
            task.wait(0.1)
            LP.Character:WaitForChild("Humanoid"):UnequipTools()
            return
        end
        clickConn = mouse.Button1Down:Connect(function()
            local part = mouse.Target
            if not part then return end
            local char = part:FindFirstAncestorWhichIsA("Model")
            if not char then return end
            local plr = Players:GetPlayerFromCharacter(char)
            if not plr then return end
            Box.Text = plr.Name
            setTarget(plr)
            SavedTargetName = plr.Name
            SavedAuto = Auto
            SavedKill = KillLoop
            if Auto and plr.Character then task.delay(0.1, function() onChar(plr.Character) end) end
            if KillLoop then task.delay(0.1, startKillLoop) end
        end)
    end)
    tool.Unequipped:Connect(function()
        if clickConn then clickConn:Disconnect() clickConn = nil end
    end)
end

if LP.Character then
    task.wait(0.5)
    createTargetTool()
    connectAntiBangTouch()
    connectAntiBangProximityLoop()
end
LP.CharacterAdded:Connect(function()
    task.wait(0.5)
    createTargetTool()
    connectAntiBangTouch()
end)
